import { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Copy, Play, Download, ExternalLink } from "lucide-react";
import { toast } from "sonner";

interface DatasetNotebookProps {
  datasetId: string;
  datasetName: string;
  description?: string;
}

const DatasetNotebook = ({ datasetId, datasetName, description }: DatasetNotebookProps) => {
  const [activeTab, setActiveTab] = useState("python");

  const pythonCode = `# ${datasetName} - Starter Notebook
# Auto-generated by Juvana Platform

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

# Configure display
pd.set_option('display.max_columns', None)
plt.style.use('seaborn-v0_8-whitegrid')

# Dataset Information
DATASET_ID = "${datasetId}"
DATASET_NAME = "${datasetName}"

# Load the dataset
# Replace with your actual data path after downloading
df = pd.read_csv('data.csv')

# Basic exploration
print(f"Dataset: {DATASET_NAME}")
print(f"Shape: {df.shape}")
print(f"\\nColumns: {list(df.columns)}")

# Display first rows
print("\\n--- First 5 rows ---")
display(df.head())

# Data types and missing values
print("\\n--- Data Info ---")
print(df.info())

# Summary statistics
print("\\n--- Summary Statistics ---")
display(df.describe())

# Check for missing values
missing = df.isnull().sum()
if missing.sum() > 0:
    print("\\n--- Missing Values ---")
    print(missing[missing > 0])
else:
    print("\\nNo missing values found!")

# Visualization example
# Uncomment and modify based on your data
# fig, axes = plt.subplots(1, 2, figsize=(12, 5))
# df['column_name'].hist(ax=axes[0])
# axes[0].set_title('Distribution')
# df.plot(kind='scatter', x='col1', y='col2', ax=axes[1])
# plt.tight_layout()
# plt.show()
`;

  const rCode = `# ${datasetName} - Starter Notebook (R)
# Auto-generated by Juvana Platform

# Load libraries
library(tidyverse)
library(ggplot2)

# Dataset Information
DATASET_ID <- "${datasetId}"
DATASET_NAME <- "${datasetName}"

# Load the dataset
df <- read_csv('data.csv')

# Basic exploration
cat("Dataset:", DATASET_NAME, "\\n")
cat("Dimensions:", dim(df), "\\n")
cat("Columns:", names(df), "\\n")

# Display first rows
head(df)

# Data structure
str(df)

# Summary statistics
summary(df)

# Check for missing values
sapply(df, function(x) sum(is.na(x)))

# Visualization example
# ggplot(df, aes(x = column_name)) +
#   geom_histogram() +
#   theme_minimal() +
#   labs(title = "Distribution")
`;

  const jupyterJson = {
    cells: [
      {
        cell_type: "markdown",
        metadata: {},
        source: [`# ${datasetName}\n\n${description || 'Dataset analysis notebook'}`]
      },
      {
        cell_type: "code",
        execution_count: null,
        metadata: {},
        source: pythonCode.split('\n').map(line => line + '\n')
      }
    ],
    metadata: {
      kernelspec: {
        display_name: "Python 3",
        language: "python",
        name: "python3"
      }
    },
    nbformat: 4,
    nbformat_minor: 4
  };

  const copyCode = (code: string) => {
    navigator.clipboard.writeText(code);
    toast.success("Code copied to clipboard!");
  };

  const downloadNotebook = () => {
    const blob = new Blob([JSON.stringify(jupyterJson, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${datasetName.toLowerCase().replace(/\s+/g, '_')}_starter.ipynb`;
    a.click();
    URL.revokeObjectURL(url);
    toast.success("Notebook downloaded!");
  };

  const openInColab = () => {
    // Create a Colab URL with the starter code
    const colabUrl = `https://colab.research.google.com/#create=true`;
    window.open(colabUrl, '_blank');
    toast.info("Paste the starter code in your Colab notebook");
  };

  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between">
        <CardTitle className="text-lg">Starter Notebook</CardTitle>
        <div className="flex gap-2">
          <Button variant="outline" size="sm" onClick={downloadNotebook}>
            <Download className="h-4 w-4 mr-1" />
            Download .ipynb
          </Button>
          <Button size="sm" onClick={openInColab}>
            <ExternalLink className="h-4 w-4 mr-1" />
            Open in Colab
          </Button>
        </div>
      </CardHeader>
      <CardContent>
        <Tabs value={activeTab} onValueChange={setActiveTab}>
          <div className="flex items-center justify-between mb-4">
            <TabsList>
              <TabsTrigger value="python">Python</TabsTrigger>
              <TabsTrigger value="r">R</TabsTrigger>
            </TabsList>
            <Button 
              variant="ghost" 
              size="sm"
              onClick={() => copyCode(activeTab === "python" ? pythonCode : rCode)}
            >
              <Copy className="h-4 w-4 mr-1" />
              Copy
            </Button>
          </div>

          <TabsContent value="python" className="mt-0">
            <div className="relative">
              <pre className="bg-muted/50 p-4 rounded-lg overflow-x-auto text-sm font-mono max-h-[500px] overflow-y-auto">
                <code className="text-foreground">{pythonCode}</code>
              </pre>
            </div>
          </TabsContent>

          <TabsContent value="r" className="mt-0">
            <div className="relative">
              <pre className="bg-muted/50 p-4 rounded-lg overflow-x-auto text-sm font-mono max-h-[500px] overflow-y-auto">
                <code className="text-foreground">{rCode}</code>
              </pre>
            </div>
          </TabsContent>
        </Tabs>

        <p className="text-xs text-muted-foreground mt-4">
          ðŸ’¡ Tip: Download the dataset files and place them in the same directory as your notebook
        </p>
      </CardContent>
    </Card>
  );
};

export default DatasetNotebook;
